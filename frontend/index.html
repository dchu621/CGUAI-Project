<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>5 ç§’å³æ™‚æŒ‡ä»¤ + æœƒå¾Œç¸½çµ</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    button { margin-right: .5rem; }
    pre { background: #f4f4f4; padding: .5rem; }
  </style>
</head>
<body>
  <h2>ğŸ™ï¸ æœƒè­°éŒ„éŸ³ & å³æ™‚æŒ‡ä»¤ç³»çµ±</h2>
  <button id="startBtn">é–‹å§‹æœƒè­°</button>
  <button id="stopBtn" disabled>çµæŸæœƒè­°</button>

  <h3>ğŸ”Š å³æ™‚è½‰éŒ„ï¼š</h3>
  <pre id="transcript">(å°šæœªé–‹å§‹)</pre>

  <h3>âš™ï¸ å³æ™‚æŒ‡ä»¤ï¼š</h3>
  <pre id="actions">(ç„¡)</pre>

  <h3>ğŸ“ æœ€çµ‚æ‘˜è¦ï¼š</h3>
  <pre id="summary">(å°šæœªçµæŸæœƒè­°)</pre>

  <!-- Recorder.js (WAV encoder) -->
  <script src="https://cdn.jsdelivr.net/gh/mattdiamond/Recorderjs@08e7abd9/dist/recorder.js"></script>

<script>
const CHUNK_MS = 5000;  // æ¯ 5 ç§’è¼¸å‡ºä¸€æ¬¡
let audioContext, input, recorder, recordInterval, meetingId;

const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const transcriptElem = document.getElementById("transcript");
const actionsElem    = document.getElementById("actions");
const summaryElem    = document.getElementById("summary");

startBtn.onclick = async () => {
  // 1ï¸âƒ£ å»ºæœƒè­°ï¼Œæ‹¿ meeting_id
  const res = await fetch("/begin_meeting", { method: "POST" });
  meetingId = (await res.json()).meeting_id;

  // 2ï¸âƒ£ å»ºç«‹ AudioContext + Recorder.js
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  input    = audioContext.createMediaStreamSource(stream);
  recorder = new Recorder(input, { numChannels: 1 });
  recorder.record();

  // 3ï¸âƒ£ æ¯ CHUNK_MS åœéŒ„ã€é€æª”ï¼Œå†é‡å•ŸéŒ„éŸ³
  recordInterval = setInterval(async () => {
    recorder.stop();
    recorder.exportWAV(async blob => {
      const form = new FormData();
      form.append("file", blob, "chunk.wav");
      form.append("meeting_id", meetingId);

      const r = await fetch("/chunk", { method: "POST", body: form });
      if (r.ok) {
        const { transcript, actions } = await r.json();
        transcriptElem.textContent = transcript;
        actionsElem.textContent = actions.length ? actions.join(", ") : "(ç„¡)";
      } else {
        console.error("chunk ä¸Šå‚³å¤±æ•—ï¼š", await r.text());
      }
    });
    recorder.clear();
    recorder.record();
  }, CHUNK_MS);

  startBtn.disabled = true;
  stopBtn.disabled  = false;
};

stopBtn.onclick = async () => {
  // åœæ­¢é€±æœŸä»»å‹™
  clearInterval(recordInterval);
  // æœ€å¾Œä¸€æ®µ
  recorder.stop();
  recorder.exportWAV(async blob => {
    const form = new FormData();
    form.append("file", blob, "chunk.wav");
    form.append("meeting_id", meetingId);
    await fetch("/chunk", { method: "POST", body: form });
  });

  // 4ï¸âƒ£ å«å¾Œç«¯åšæœ€çµ‚æ‘˜è¦
  const r = await fetch(`/end_meeting?meeting_id=${meetingId}`);
  const { summary } = await r.json();
  summaryElem.textContent = summary;

  startBtn.disabled = false;
  stopBtn.disabled  = true;
};
</script>
</body>
</html>
